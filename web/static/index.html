<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IhopeCash Web 导入工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 顶部导航栏 -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-5xl mx-auto px-4 sm:px-6">
            <div class="flex justify-between items-center h-14">
                <div class="flex items-center space-x-8">
                    <a href="/" class="text-lg font-bold text-gray-900 tracking-tight">IhopeCash</a>
                    <div class="flex space-x-1">
                        <a href="/" class="px-3 py-1.5 text-sm font-medium rounded-lg bg-blue-50 text-blue-700">导入</a>
                        <a href="/config" class="px-3 py-1.5 text-sm font-medium rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-100 transition">配置</a>
                        <a href="/fava/" target="_blank" class="px-3 py-1.5 text-sm font-medium rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-100 transition">账本</a>
                    </div>
                </div>
                <button
                    id="logoutBtn"
                    class="text-sm text-gray-500 hover:text-gray-700 transition"
                >
                    退出登录
                </button>
            </div>
        </div>
    </nav>

    <div class="max-w-3xl mx-auto px-4 sm:px-6 py-6 space-y-5">

        <!-- 账单信息表单 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
            <h2 class="text-base font-semibold text-gray-800 mb-4">账单信息</h2>
            
            <form id="importForm" class="space-y-4">
                <!-- 年月选择 -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="year" class="block text-sm font-medium text-gray-600 mb-1">年份</label>
                        <select
                            id="year"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm"
                        ></select>
                    </div>
                    <div>
                        <label for="month" class="block text-sm font-medium text-gray-600 mb-1">月份</label>
                        <select
                            id="month"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm"
                        ></select>
                    </div>
                </div>

                <!-- 导入模式 -->
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-2">导入模式</label>
                    <div class="grid grid-cols-3 gap-2">
                        <label class="flex items-center justify-center px-3 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 has-[:checked]:text-blue-700">
                            <input type="radio" name="mode" value="normal" checked class="sr-only">
                            <span class="text-sm font-medium">通常模式</span>
                        </label>
                        <label class="flex items-center justify-center px-3 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 has-[:checked]:text-blue-700">
                            <input type="radio" name="mode" value="force" class="sr-only">
                            <span class="text-sm font-medium">强制覆盖</span>
                        </label>
                        <label class="flex items-center justify-center px-3 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 has-[:checked]:text-blue-700">
                            <input type="radio" name="mode" value="append" class="sr-only">
                            <span class="text-sm font-medium">追加模式</span>
                        </label>
                    </div>
                    <div id="modeDescription" class="mt-2 text-xs text-gray-500">
                        目录已存在时报错
                    </div>
                </div>
            </form>
        </div>

        <!-- 附件密码 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-base font-semibold text-gray-800">附件密码</h2>
                <button
                    id="addPasswordBtn"
                    type="button"
                    class="text-sm text-blue-600 hover:text-blue-700 font-medium transition"
                >
                    + 添加密码
                </button>
            </div>
            <p class="text-xs text-gray-400 mb-3">PDF/ZIP 附件的解压密码，留空表示无需密码</p>
            <div id="passwordInputs" class="space-y-2">
                <!-- 动态生成密码输入框 -->
            </div>
            <div id="noPasswordHint" class="text-sm text-gray-400 text-center py-3">
                暂无密码，点击上方"添加密码"按钮添加
            </div>
        </div>

        <!-- 账户余额表单 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
            <h2 class="text-base font-semibold text-gray-800 mb-4">账户余额</h2>
            <div id="balanceInputs" class="space-y-3">
                <!-- 动态生成余额输入框 -->
            </div>
        </div>

        <!-- 执行日志 -->
        <div id="progressSection" class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 hidden">
            <h2 class="text-base font-semibold text-gray-800 mb-3">执行日志</h2>
            <div
                id="logArea"
                class="bg-gray-50 rounded-lg p-3 max-h-80 overflow-y-auto font-mono text-sm space-y-0.5"
            >
            </div>
        </div>

        <!-- 按钮组 -->
        <div class="flex gap-3">
            <button
                id="startBtn"
                class="flex-1 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-semibold py-2.5 px-6 rounded-xl transition-all duration-200 shadow-sm hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed"
            >
                开始导入
            </button>
            <button
                id="resetBtn"
                class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2.5 px-6 rounded-xl transition-all duration-200"
            >
                重置
            </button>
        </div>
    </div>

    <script>
        // ==================== 全局变量 ====================
        let config = null;
        let ws = null;
        let currentTaskId = null;

        // DOM 元素
        const importForm = document.getElementById('importForm');
        const yearSelect = document.getElementById('year');
        const monthSelect = document.getElementById('month');
        const balanceInputs = document.getElementById('balanceInputs');
        const passwordInputs = document.getElementById('passwordInputs');
        const noPasswordHint = document.getElementById('noPasswordHint');
        const addPasswordBtn = document.getElementById('addPasswordBtn');
        const progressSection = document.getElementById('progressSection');
        const logArea = document.getElementById('logArea');
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const modeDescription = document.getElementById('modeDescription');

        const modeDescriptions = {
            normal: '目录已存在时报错',
            force: '删除已有目录并重新创建',
            append: '向已有月份添加新交易'
        };

        // ==================== 认证 ====================

        function checkAuth() {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                window.location.href = '/login';
                return false;
            }
            return true;
        }

        function getAuthHeaders() {
            const token = localStorage.getItem('auth_token');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        // ==================== 初始化 ====================

        async function init() {
            if (!checkAuth()) return;

            try {
                const response = await fetch('/api/config', {
                    headers: getAuthHeaders()
                });

                if (response.status === 401) {
                    localStorage.removeItem('auth_token');
                    window.location.href = '/login';
                    return;
                }

                config = await response.json();
                initYearMonth();
                initBalanceInputs();
                initModeRadios();
            } catch (error) {
                console.error('Init error:', error);
                alert('加载配置失败');
            }
        }

        function initYearMonth() {
            const currentYear = new Date().getFullYear();
            for (let y = currentYear - 5; y <= currentYear + 5; y++) {
                const option = document.createElement('option');
                option.value = y;
                option.textContent = y;
                if (y === config.default_year) option.selected = true;
                yearSelect.appendChild(option);
            }

            for (let m = 1; m <= 12; m++) {
                const option = document.createElement('option');
                option.value = m;
                option.textContent = m.toString().padStart(2, '0');
                if (m === config.default_month) option.selected = true;
                monthSelect.appendChild(option);
            }
        }

        function initBalanceInputs() {
            balanceInputs.innerHTML = '';
            config.balance_accounts.forEach(account => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-3';
                div.innerHTML = `
                    <label class="w-1/2 text-sm text-gray-600 truncate" title="${account}">${account}</label>
                    <div class="flex-1 flex items-center gap-2">
                        <input
                            type="text"
                            data-account="${account}"
                            class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm"
                            placeholder="输入余额"
                            required
                        />
                        <span class="text-xs text-gray-400 w-8">CNY</span>
                    </div>
                `;
                balanceInputs.appendChild(div);
            });
        }

        function initModeRadios() {
            document.querySelectorAll('input[name="mode"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    modeDescription.textContent = modeDescriptions[radio.value] || '';
                });
            });
        }

        // ==================== Passwords 动态列表 ====================

        addPasswordBtn.addEventListener('click', () => {
            addPasswordInput();
        });

        function addPasswordInput(value = '') {
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2';
            div.innerHTML = `
                <input
                    type="password"
                    class="password-field flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm"
                    placeholder="输入密码"
                    value="${value}"
                />
                <button type="button" class="remove-password-btn text-gray-400 hover:text-red-500 transition p-1" title="删除">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            `;
            passwordInputs.appendChild(div);
            noPasswordHint.classList.add('hidden');

            div.querySelector('.remove-password-btn').addEventListener('click', () => {
                div.remove();
                if (passwordInputs.children.length === 0) {
                    noPasswordHint.classList.remove('hidden');
                }
            });
        }

        function getPasswords() {
            const passwords = [];
            passwordInputs.querySelectorAll('.password-field').forEach(input => {
                const val = input.value.trim();
                if (val) passwords.push(val);
            });
            return passwords;
        }

        // ==================== 表单提交 ====================

        startBtn.addEventListener('click', async () => {
            const year = yearSelect.value;
            const month = monthSelect.value;
            const mode = document.querySelector('input[name="mode"]:checked').value;
            const passwords = getPasswords();

            // 收集余额
            const balances = {};
            const balanceFields = balanceInputs.querySelectorAll('input[data-account]');
            let isValid = true;

            balanceFields.forEach(input => {
                const account = input.dataset.account;
                const value = input.value.trim();

                if (!value) {
                    isValid = false;
                    input.classList.add('border-red-400');
                    input.classList.remove('border-gray-300');
                } else if (isNaN(parseFloat(value))) {
                    isValid = false;
                    input.classList.add('border-red-400');
                    input.classList.remove('border-gray-300');
                } else {
                    balances[account] = value;
                    input.classList.remove('border-red-400');
                    input.classList.add('border-gray-300');
                }
            });

            if (!isValid) {
                alert('请填写所有账户余额，并确保输入的是数字');
                return;
            }

            disableForm();
            progressSection.classList.remove('hidden');
            logArea.innerHTML = '';
            addLog('准备开始...', 'running');

            try {
                const response = await fetch('/api/import', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ year, month, mode, balances, passwords })
                });

                if (response.status === 401) {
                    localStorage.removeItem('auth_token');
                    window.location.href = '/login';
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    currentTaskId = data.task_id;
                    addLog('任务已创建，正在连接...', 'success');
                    connectWebSocket(currentTaskId);
                } else {
                    addLog('启动任务失败: ' + data.message, 'error');
                    enableForm();
                }

            } catch (error) {
                console.error('Import error:', error);
                addLog('网络错误: ' + error.message, 'error');
                enableForm();
            }
        });

        // ==================== WebSocket ====================

        function connectWebSocket(taskId) {
            const token = localStorage.getItem('auth_token');
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/progress?token=${token}`;

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                addLog('连接已建立', 'success');
                ws.send(JSON.stringify({ task_id: taskId }));
            };

            ws.onmessage = (event) => {
                const progress = JSON.parse(event.data);
                handleProgress(progress);
            };

            ws.onerror = (error) => {
                addLog('WebSocket 错误', 'error');
                console.error('WebSocket error:', error);
            };

            ws.onclose = () => {
                addLog('连接已关闭', 'success');
            };
        }

        function handleProgress(progress) {
            const { step, total, step_name, status, message, details } = progress;

            const stepText = step > 0 ? `[${step}/${total}] ` : '';
            addLog(`${stepText}${message}`, status);

            if (details) {
                if (details.output) {
                    addLog(`  ${details.output}`, 'running');
                }
                if (details.files_count) {
                    addLog(`  文件数: ${details.files_count}`, 'running');
                }
            }

            if (status === 'success' && step === total) {
                addLog('导入完成!', 'success');
                enableForm();
                closeWebSocket();
            }

            if (status === 'error') {
                enableForm();
                closeWebSocket();
            }
        }

        function closeWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        // ==================== 日志 ====================

        function addLog(message, status = '') {
            const entry = document.createElement('div');
            let icon = '';
            let cssClass = 'log-entry';

            switch (status) {
                case 'success':
                    icon = '\u2713 ';
                    cssClass += ' log-success';
                    break;
                case 'error':
                    icon = '\u2717 ';
                    cssClass += ' log-error';
                    break;
                case 'running':
                    icon = '\u25b6 ';
                    cssClass += ' log-running';
                    break;
            }

            entry.className = cssClass;
            entry.textContent = icon + message;
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        // ==================== 表单控制 ====================

        function disableForm() {
            importForm.querySelectorAll('input, select').forEach(el => el.disabled = true);
            balanceInputs.querySelectorAll('input').forEach(el => el.disabled = true);
            passwordInputs.querySelectorAll('input, button').forEach(el => el.disabled = true);
            addPasswordBtn.disabled = true;
            startBtn.disabled = true;
        }

        function enableForm() {
            importForm.querySelectorAll('input, select').forEach(el => el.disabled = false);
            balanceInputs.querySelectorAll('input').forEach(el => el.disabled = false);
            passwordInputs.querySelectorAll('input, button').forEach(el => el.disabled = false);
            addPasswordBtn.disabled = false;
            startBtn.disabled = false;
        }

        // ==================== 重置 ====================

        resetBtn.addEventListener('click', () => {
            closeWebSocket();
            logArea.innerHTML = '';
            progressSection.classList.add('hidden');

            balanceInputs.querySelectorAll('input').forEach(input => {
                input.value = '';
                input.classList.remove('border-red-400');
                input.classList.add('border-gray-300');
            });

            // 清空密码列表
            passwordInputs.innerHTML = '';
            noPasswordHint.classList.remove('hidden');

            document.querySelector('input[name="mode"][value="normal"]').checked = true;
            modeDescription.textContent = modeDescriptions.normal;

            enableForm();
            currentTaskId = null;
        });

        // ==================== 退出登录 ====================

        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('token_expire_at');
            window.location.href = '/login';
        });

        // ==================== 页面加载 ====================

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
