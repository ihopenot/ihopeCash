<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IhopeCash Web å¯¼å…¥å·¥å…·</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- å¤´éƒ¨ -->
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">
                ğŸ“Š IhopeCash Web å¯¼å…¥å·¥å…·
            </h1>
            <button
                id="logoutBtn"
                class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200"
            >
                é€€å‡ºç™»å½•
            </button>
        </div>

        <!-- è´¦å•ä¿¡æ¯è¡¨å• -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">ğŸ“… è´¦å•ä¿¡æ¯</h2>
            
            <form id="importForm" class="space-y-4">
                <!-- å¹´æœˆé€‰æ‹© -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="year" class="block text-sm font-medium text-gray-700 mb-2">
                            å¹´ä»½
                        </label>
                        <select
                            id="year"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                            <!-- åŠ¨æ€ç”Ÿæˆå¹´ä»½é€‰é¡¹ -->
                        </select>
                    </div>
                    <div>
                        <label for="month" class="block text-sm font-medium text-gray-700 mb-2">
                            æœˆä»½
                        </label>
                        <select
                            id="month"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                            <!-- åŠ¨æ€ç”Ÿæˆæœˆä»½é€‰é¡¹ -->
                        </select>
                    </div>
                </div>

                <!-- å¯¼å…¥æ¨¡å¼ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        å¯¼å…¥æ¨¡å¼
                    </label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="radio" name="mode" value="normal" checked class="mr-2">
                            <span class="text-sm">é€šå¸¸æ¨¡å¼</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="mode" value="force" class="mr-2">
                            <span class="text-sm">å¼ºåˆ¶è¦†ç›–</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="mode" value="append" class="mr-2">
                            <span class="text-sm">è¿½åŠ æ¨¡å¼</span>
                        </label>
                    </div>
                    <div class="mt-2 text-xs text-gray-600 space-y-1">
                        <p>â„¹ï¸ <strong>é€šå¸¸æ¨¡å¼</strong>: ç›®å½•å·²å­˜åœ¨æ—¶æŠ¥é”™</p>
                        <p>â„¹ï¸ <strong>å¼ºåˆ¶è¦†ç›–</strong>: åˆ é™¤å·²æœ‰ç›®å½•å¹¶é‡æ–°åˆ›å»º</p>
                        <p>â„¹ï¸ <strong>è¿½åŠ æ¨¡å¼</strong>: å‘å·²æœ‰æœˆä»½æ·»åŠ æ–°äº¤æ˜“</p>
                    </div>
                </div>
            </form>
        </div>

        <!-- è´¦æˆ·ä½™é¢è¡¨å• -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">ğŸ’° è´¦æˆ·ä½™é¢</h2>
            <div id="balanceInputs" class="space-y-3">
                <!-- åŠ¨æ€ç”Ÿæˆä½™é¢è¾“å…¥æ¡† -->
            </div>
        </div>

        <!-- æ‰§è¡Œæ—¥å¿— -->
        <div id="progressSection" class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">ğŸ“‹ æ‰§è¡Œæ—¥å¿—</h2>
            <div
                id="logArea"
                class="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto font-mono text-sm"
            >
                <!-- åŠ¨æ€æ·»åŠ æ—¥å¿—æ¡ç›® -->
            </div>
        </div>

        <!-- æŒ‰é’®ç»„ -->
        <div class="flex gap-4">
            <button
                id="startBtn"
                class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200"
            >
                ğŸš€ å¼€å§‹å¯¼å…¥
            </button>
            <button
                id="resetBtn"
                class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200"
            >
                ğŸ”„ é‡ç½®
            </button>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let config = null;
        let ws = null;
        let currentTaskId = null;

        // DOM å…ƒç´ 
        const importForm = document.getElementById('importForm');
        const yearSelect = document.getElementById('year');
        const monthSelect = document.getElementById('month');
        const balanceInputs = document.getElementById('balanceInputs');
        const progressSection = document.getElementById('progressSection');
        const logArea = document.getElementById('logArea');
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');
        const logoutBtn = document.getElementById('logoutBtn');

        // ==================== è®¤è¯æ£€æŸ¥ ====================

        function checkAuth() {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                window.location.href = '/login';
                return false;
            }
            return true;
        }

        function getAuthHeaders() {
            const token = localStorage.getItem('auth_token');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        // ==================== åˆå§‹åŒ– ====================

        async function init() {
            if (!checkAuth()) return;

            try {
                // è·å–é…ç½®
                const response = await fetch('/api/config', {
                    headers: getAuthHeaders()
                });

                if (response.status === 401) {
                    // Token æ— æ•ˆæˆ–è¿‡æœŸ
                    localStorage.removeItem('auth_token');
                    window.location.href = '/login';
                    return;
                }

                config = await response.json();

                // åˆå§‹åŒ–å¹´æœˆé€‰æ‹©å™¨
                initYearMonth();

                // åˆå§‹åŒ–ä½™é¢è¾“å…¥æ¡†
                initBalanceInputs();

            } catch (error) {
                console.error('Init error:', error);
                alert('åŠ è½½é…ç½®å¤±è´¥');
            }
        }

        function initYearMonth() {
            // ç”Ÿæˆå¹´ä»½é€‰é¡¹ï¼ˆå‰å5å¹´ï¼‰
            const currentYear = new Date().getFullYear();
            for (let y = currentYear - 5; y <= currentYear + 5; y++) {
                const option = document.createElement('option');
                option.value = y;
                option.textContent = y;
                if (y === config.default_year) option.selected = true;
                yearSelect.appendChild(option);
            }

            // ç”Ÿæˆæœˆä»½é€‰é¡¹
            for (let m = 1; m <= 12; m++) {
                const option = document.createElement('option');
                option.value = m;
                option.textContent = m.toString().padStart(2, '0');
                if (m === config.default_month) option.selected = true;
                monthSelect.appendChild(option);
            }
        }

        function initBalanceInputs() {
            balanceInputs.innerHTML = '';

            config.balance_accounts.forEach(account => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2';
                div.innerHTML = `
                    <label class="w-1/2 text-sm text-gray-700">${account}</label>
                    <input
                        type="text"
                        name="balance_${account}"
                        data-account="${account}"
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="è¾“å…¥ä½™é¢"
                        required
                    />
                    <span class="text-sm text-gray-500">CNY</span>
                `;
                balanceInputs.appendChild(div);
            });
        }

        // ==================== è¡¨å•æäº¤ ====================

        startBtn.addEventListener('click', async () => {
            // éªŒè¯è¡¨å•
            const year = yearSelect.value;
            const month = monthSelect.value;
            const mode = document.querySelector('input[name="mode"]:checked').value;

            // æ”¶é›†ä½™é¢
            const balances = {};
            const balanceFields = balanceInputs.querySelectorAll('input[data-account]');
            let isValid = true;

            balanceFields.forEach(input => {
                const account = input.dataset.account;
                const value = input.value.trim();

                if (!value) {
                    isValid = false;
                    input.classList.add('border-red-500');
                } else if (isNaN(parseFloat(value))) {
                    isValid = false;
                    input.classList.add('border-red-500');
                } else {
                    balances[account] = value;
                    input.classList.remove('border-red-500');
                }
            });

            if (!isValid) {
                alert('è¯·å¡«å†™æ‰€æœ‰è´¦æˆ·ä½™é¢ï¼Œå¹¶ç¡®ä¿è¾“å…¥çš„æ˜¯æ•°å­—');
                return;
            }

            // ç¦ç”¨è¡¨å•
            disableForm();

            // æ˜¾ç¤ºè¿›åº¦åŒºåŸŸ
            progressSection.classList.remove('hidden');
            logArea.innerHTML = '<div class="log-entry">â³ å‡†å¤‡å¼€å§‹...</div>';

            try {
                // å‘é€å¯¼å…¥è¯·æ±‚
                const response = await fetch('/api/import', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ year, month, mode, balances })
                });

                if (response.status === 401) {
                    localStorage.removeItem('auth_token');
                    window.location.href = '/login';
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    currentTaskId = data.task_id;
                    addLog('âœ“ ä»»åŠ¡å·²åˆ›å»ºï¼Œå¼€å§‹è¿æ¥...');

                    // å»ºç«‹ WebSocket è¿æ¥
                    connectWebSocket(currentTaskId);
                } else {
                    addLog('âŒ å¯åŠ¨ä»»åŠ¡å¤±è´¥: ' + data.message);
                    enableForm();
                }

            } catch (error) {
                console.error('Import error:', error);
                addLog('âŒ ç½‘ç»œé”™è¯¯: ' + error.message);
                enableForm();
            }
        });

        // ==================== WebSocket ====================

        function connectWebSocket(taskId) {
            const token = localStorage.getItem('auth_token');
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/progress?token=${token}`;

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                addLog('âœ“ è¿æ¥å·²å»ºç«‹');
                // å‘é€ task_id
                ws.send(JSON.stringify({ task_id: taskId }));
            };

            ws.onmessage = (event) => {
                const progress = JSON.parse(event.data);
                handleProgress(progress);
            };

            ws.onerror = (error) => {
                addLog('âŒ WebSocket é”™è¯¯');
                console.error('WebSocket error:', error);
            };

            ws.onclose = () => {
                addLog('âœ“ è¿æ¥å·²å…³é—­');
            };
        }

        function handleProgress(progress) {
            const { step, total, step_name, status, message, details } = progress;

            let icon = 'â³';
            if (status === 'success') icon = 'âœ“';
            if (status === 'error') icon = 'âŒ';

            const stepText = step > 0 ? `[${step}/${total}] ` : '';
            addLog(`${icon} ${stepText}${message}`);

            // æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
            if (details) {
                if (details.output) {
                    addLog(`   ${details.output}`, 'text-gray-600');
                }
                if (details.files_count) {
                    addLog(`   æ–‡ä»¶æ•°: ${details.files_count}`, 'text-blue-600');
                }
            }

            // å¦‚æœæ˜¯æœ€åä¸€æ­¥æˆåŠŸï¼Œæ˜¾ç¤ºå®Œæˆæ¶ˆæ¯
            if (status === 'success' && step === total) {
                addLog('ğŸ‰ å¯¼å…¥å®Œæˆï¼', 'text-green-600 font-bold');
                enableForm();
                closeWebSocket();
            }

            // å¦‚æœå‡ºé”™ï¼Œå¯ç”¨è¡¨å•
            if (status === 'error') {
                enableForm();
                closeWebSocket();
            }
        }

        function closeWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        // ==================== æ—¥å¿—æ˜¾ç¤º ====================

        function addLog(message, className = '') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${className}`;
            entry.textContent = message;
            logArea.appendChild(entry);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            logArea.scrollTop = logArea.scrollHeight;
        }

        // ==================== è¡¨å•æ§åˆ¶ ====================

        function disableForm() {
            importForm.querySelectorAll('input, select, button').forEach(el => {
                el.disabled = true;
            });
            balanceInputs.querySelectorAll('input').forEach(el => {
                el.disabled = true;
            });
            startBtn.disabled = true;
            resetBtn.disabled = false;
        }

        function enableForm() {
            importForm.querySelectorAll('input, select, button').forEach(el => {
                el.disabled = false;
            });
            balanceInputs.querySelectorAll('input').forEach(el => {
                el.disabled = false;
            });
            startBtn.disabled = false;
        }

        // ==================== é‡ç½® ====================

        resetBtn.addEventListener('click', () => {
            // å…³é—­ WebSocket
            closeWebSocket();

            // æ¸…ç©ºæ—¥å¿—
            logArea.innerHTML = '';
            progressSection.classList.add('hidden');

            // æ¸…ç©ºä½™é¢è¾“å…¥
            balanceInputs.querySelectorAll('input').forEach(input => {
                input.value = '';
                input.classList.remove('border-red-500');
            });

            // é‡ç½®æ¨¡å¼ä¸ºé€šå¸¸
            document.querySelector('input[name="mode"][value="normal"]').checked = true;

            // å¯ç”¨è¡¨å•
            enableForm();

            currentTaskId = null;
        });

        // ==================== é€€å‡ºç™»å½• ====================

        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('token_expire_at');
            window.location.href = '/login';
        });

        // ==================== é¡µé¢åŠ è½½ ====================

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
