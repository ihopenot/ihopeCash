<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置管理 - IhopeCash Web</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 顶部导航栏 -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-5xl mx-auto px-4 sm:px-6">
            <div class="flex justify-between items-center h-14">
                <div class="flex items-center space-x-8">
                    <a href="/" class="text-lg font-bold text-gray-900 tracking-tight">IhopeCash</a>
                    <div class="flex space-x-1">
                        <a href="/" class="px-3 py-1.5 text-sm font-medium rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-100 transition">导入</a>
                        <a href="/config" class="px-3 py-1.5 text-sm font-medium rounded-lg bg-blue-50 text-blue-700">配置</a>
                        <a href="/fava/" target="_blank" class="px-3 py-1.5 text-sm font-medium rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-100 transition">账本</a>
                    </div>
                </div>
                <button id="logoutBtn" class="text-sm text-gray-500 hover:text-gray-700 transition">退出登录</button>
            </div>
        </div>
    </nav>

    <div class="max-w-3xl mx-auto px-4 sm:px-6 py-6">
        <!-- 消息提示 -->
        <div id="messageBar" class="hidden rounded-xl p-4 mb-5 transition-all"></div>

        <!-- Tab 切换 -->
        <div class="flex space-x-1 bg-gray-100 p-1 rounded-xl mb-5">
            <button class="tab-btn flex-1 py-2 text-sm font-medium rounded-lg transition" data-tab="ledger">账本</button>
            <button class="tab-btn flex-1 py-2 text-sm font-medium rounded-lg transition" data-tab="basic">基础配置</button>
            <button class="tab-btn flex-1 py-2 text-sm font-medium rounded-lg transition" data-tab="advanced">高级配置</button>
            <button class="tab-btn flex-1 py-2 text-sm font-medium rounded-lg transition" data-tab="password">修改密码</button>
        </div>

        <!-- ==================== Tab 0: 账本 ==================== -->
        <div id="tab-ledger" class="tab-content space-y-5">
            <!-- 基本信息 -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                <h3 class="text-base font-semibold text-gray-800 mb-4">基本信息</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">账本名称</label>
                        <input type="text" id="ledger_title" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm" placeholder="ihopeCash">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">主货币</label>
                        <input type="text" id="ledger_currency" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm" placeholder="CNY">
                    </div>
                </div>
                <div class="flex justify-end mt-4">
                    <button id="saveLedgerInfoBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-xl transition-all shadow-sm">保存基本信息</button>
                </div>
            </div>

            <!-- 账户管理 -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                <h3 class="text-base font-semibold text-gray-800 mb-4">账户管理</h3>

                <!-- 新增账户表单 -->
                <div class="border border-gray-200 rounded-lg p-4 mb-5 bg-gray-50">
                    <h4 class="text-sm font-semibold text-gray-700 mb-3">新增账户</h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">账户类型</label>
                            <select id="newAccType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm bg-white">
                                <option value="Assets">Assets (资产)</option>
                                <option value="Liabilities">Liabilities (负债)</option>
                                <option value="Income">Income (收入)</option>
                                <option value="Expenses">Expenses (支出)</option>
                                <option value="Equity">Equity (权益)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">账户路径</label>
                            <input type="text" id="newAccPath" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm" placeholder="例如 BoC:Card:1234">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">货币</label>
                            <input type="text" id="newAccCurrency" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm" placeholder="留空支持所有货币">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">备注</label>
                            <input type="text" id="newAccComment" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm" placeholder="描述信息">
                        </div>
                    </div>
                    <!-- 校验错误提示 -->
                    <p id="newAccError" class="text-xs text-red-500 mt-2 hidden"></p>
                    <!-- 实时预览 -->
                    <div id="newAccPreview" class="mt-3 px-3 py-2 bg-white border border-gray-200 rounded-lg text-xs font-mono text-gray-600 hidden"></div>
                    <div class="flex justify-end mt-3">
                        <button id="addNewAccBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-1.5 px-4 rounded-lg transition-all text-sm">添加账户</button>
                    </div>
                </div>

                <!-- 账户列表 -->
                <div id="accountGroupsList" class="space-y-3">
                    <!-- 动态生成 -->
                </div>
            </div>
        </div>

        <!-- ==================== Tab 1: 基础配置 ==================== -->
        <div id="tab-basic" class="tab-content space-y-5 hidden">
            <!-- 警告提示 -->
            <div class="bg-amber-50 border border-amber-200 rounded-xl p-4">
                <div class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-amber-500 mt-0.5 shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.168 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg>
                    <p class="text-sm text-amber-800">由于 Beancount 无法动态修改账户名，账户内有数据的情况下请<strong>不要修改账户名</strong>。修改后可能导致数据不一致。</p>
                </div>
            </div>

            <!-- 余额账户 -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-base font-semibold text-gray-800">余额账户 (balance_accounts)</h3>
                    <button id="addAccountBtn" type="button" class="text-sm text-blue-600 hover:text-blue-700 font-medium transition">+ 添加账户</button>
                </div>
                <div id="accountsList" class="space-y-2">
                    <!-- 动态生成 -->
                </div>
            </div>

            <!-- 邮箱配置 -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                <h3 class="text-base font-semibold text-gray-800 mb-4">邮箱配置 (email.imap)</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">IMAP 服务器</label>
                        <input type="text" id="email_host" class="cfg-input w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm" placeholder="imap.qq.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">端口</label>
                        <input type="number" id="email_port" class="cfg-input w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm" placeholder="993">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">用户名</label>
                        <input type="text" id="email_username" class="cfg-input w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm" placeholder="user@qq.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">密码</label>
                        <input type="password" id="email_password" class="cfg-input w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm" placeholder="留空表示不修改">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-600 mb-1">邮箱文件夹</label>
                        <input type="text" id="email_mailbox" class="cfg-input w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm" placeholder="INBOX">
                    </div>
                </div>
            </div>

            <!-- 保存按钮 -->
            <div class="flex justify-end">
                <button id="saveBasicBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-xl transition-all shadow-sm">保存基础配置</button>
            </div>
        </div>

        <!-- ==================== Tab 2: 高级配置 ==================== -->
        <div id="tab-advanced" class="tab-content space-y-5 hidden">
            <!-- 通用账户 -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                <h3 class="text-base font-semibold text-gray-800 mb-4">通用账户</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">默认支出账户</label>
                        <input type="text" id="unknown_expense_account" class="cfg-input w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">默认收入账户</label>
                        <input type="text" id="unknown_income_account" class="cfg-input w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm">
                    </div>
                </div>
            </div>

            <!-- 支付宝导入器 -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                <h3 class="text-base font-semibold text-gray-800 mb-4">支付宝 (importers.alipay)</h3>
                <div class="space-y-3" id="alipay_fields"></div>
            </div>

            <!-- 微信导入器 -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                <h3 class="text-base font-semibold text-gray-800 mb-4">微信 (importers.wechat)</h3>
                <div class="space-y-3" id="wechat_fields"></div>
            </div>

            <!-- 清华饭卡导入器 -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                <h3 class="text-base font-semibold text-gray-800 mb-4">清华饭卡 (importers.thu_ecard)</h3>
                <div class="space-y-3" id="thu_ecard_fields"></div>
            </div>

            <!-- HSBC HK 导入器 -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                <h3 class="text-base font-semibold text-gray-800 mb-4">HSBC HK (importers.hsbc_hk)</h3>
                <div class="space-y-3">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="hsbc_use_cnh" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <label class="text-sm text-gray-600" for="hsbc_use_cnh">use_cnh（使用离岸人民币 CNH）</label>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">One 账户</label>
                        <input type="text" id="hsbc_account_one" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm" placeholder="例如 Assets:Bank:HSBC">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">PULSE 账户</label>
                        <input type="text" id="hsbc_account_pulse" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm" placeholder="例如 Liabilities:CreditCards:HSBC:Pulse">
                    </div>
                </div>
            </div>

            <!-- 卡号摘要过滤 -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                <h3 class="text-base font-semibold text-gray-800 mb-4">交易摘要过滤</h3>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-sm font-medium text-gray-600">白名单 (card_narration_whitelist)</label>
                            <button type="button" class="add-list-btn text-sm text-blue-600 hover:text-blue-700 font-medium" data-target="whitelist_items">+ 添加</button>
                        </div>
                        <div id="whitelist_items" class="space-y-2"></div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-sm font-medium text-gray-600">黑名单 (card_narration_blacklist)</label>
                            <button type="button" class="add-list-btn text-sm text-blue-600 hover:text-blue-700 font-medium" data-target="blacklist_items">+ 添加</button>
                        </div>
                        <div id="blacklist_items" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <!-- 卡号账户映射 -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-base font-semibold text-gray-800">卡号账户映射 (card_accounts)</h3>
                    <button id="addCardAccountBtn" type="button" class="text-sm text-blue-600 hover:text-blue-700 font-medium">+ 添加映射</button>
                </div>
                <p class="text-xs text-gray-400 mb-3">格式：类型:中间名:后四位 → 例如 Assets:BOC:Card:1234</p>
                <div id="cardAccountRows" class="space-y-3">
                    <!-- 动态生成 -->
                </div>
            </div>

            <!-- 交易匹配规则 -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-base font-semibold text-gray-800">交易匹配规则 (detail_mappings)</h3>
                    <button id="addMappingBtn" type="button" class="text-sm text-blue-600 hover:text-blue-700 font-medium">+ 添加规则</button>
                </div>
                <div id="detailMappingsList" class="space-y-3"></div>
            </div>

            <!-- 保存按钮 -->
            <div class="flex justify-end">
                <button id="saveAdvancedBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-xl transition-all shadow-sm">保存高级配置</button>
            </div>
        </div>

        <!-- ==================== Tab 3: 修改密码 ==================== -->
        <div id="tab-password" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                <h3 class="text-base font-semibold text-gray-800 mb-4">修改登录密码</h3>
                <form id="changePasswordForm" class="space-y-4 max-w-md">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">当前密码</label>
                        <input type="password" id="currentPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">新密码</label>
                        <input type="password" id="newPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">确认新密码</label>
                        <input type="password" id="confirmPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm" required>
                    </div>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-xl transition-all shadow-sm">修改密码</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 关闭账户确认对话框 -->
    <div id="closeAccountModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 p-6">
            <h3 class="text-base font-semibold text-gray-800 mb-3">确认关闭账户</h3>
            <p class="text-sm text-gray-600 mb-2">确定要关闭以下账户吗？</p>
            <p id="closeAccountName" class="text-sm font-medium text-gray-900 mb-4"></p>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-600 mb-1">关闭日期</label>
                <input type="date" id="closeAccountDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm">
            </div>
            <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-4">
                <p class="text-xs text-amber-800">关闭后该账户不能再记录新交易，且关闭日期后账户余额必须为零。此操作不可撤销。</p>
            </div>
            <div class="flex justify-end gap-3">
                <button id="closeAccountCancel" class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-800 transition">取消</button>
                <button id="closeAccountConfirm" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition-all text-sm">确认关闭</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== 全局 ====================
        let configData = null;
        const ACCOUNT_TYPE_LABELS = {
            'Assets': '资产',
            'Liabilities': '负债',
            'Income': '收入',
            'Expenses': '支出',
            'Equity': '权益'
        };

        function checkAuth() {
            const token = localStorage.getItem('auth_token');
            if (!token) { window.location.href = '/login'; return false; }
            return true;
        }

        function getAuthHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
            };
        }

        function showMessage(text, type = 'success') {
            const bar = document.getElementById('messageBar');
            bar.className = type === 'success'
                ? 'rounded-xl p-4 mb-5 bg-green-50 border border-green-200 text-green-800 text-sm'
                : 'rounded-xl p-4 mb-5 bg-red-50 border border-red-200 text-red-800 text-sm';
            bar.textContent = text;
            bar.classList.remove('hidden');
            setTimeout(() => bar.classList.add('hidden'), 4000);
        }

        // ==================== Tab 切换 ====================

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('bg-white', 'shadow-sm', 'text-gray-900');
                    b.classList.add('text-gray-500');
                });
                btn.classList.add('bg-white', 'shadow-sm', 'text-gray-900');
                btn.classList.remove('text-gray-500');
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(`tab-${tab}`).classList.remove('hidden');
            });
        });

        // 默认选中账本 tab
        document.querySelector('.tab-btn[data-tab="ledger"]').click();

        // ==================== 账本 Tab: 基本信息 ====================

        async function loadLedgerInfo() {
            try {
                const resp = await fetch('/api/ledger/info', { headers: getAuthHeaders() });
                if (resp.status === 401) { localStorage.removeItem('auth_token'); window.location.href = '/login'; return; }
                const data = await resp.json();
                document.getElementById('ledger_title').value = data.title || '';
                document.getElementById('ledger_currency').value = data.operating_currency || '';
            } catch (e) {
                console.error('Load ledger info error:', e);
            }
        }

        document.getElementById('saveLedgerInfoBtn').addEventListener('click', async () => {
            const title = document.getElementById('ledger_title').value.trim();
            const currency = document.getElementById('ledger_currency').value.trim();
            if (!title) { showMessage('账本名称不能为空', 'error'); return; }
            if (!currency) { showMessage('主货币不能为空', 'error'); return; }
            try {
                const resp = await fetch('/api/ledger/info', {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ title, operating_currency: currency })
                });
                const result = await resp.json();
                if (resp.ok && result.success) {
                    showMessage(result.message);
                } else {
                    showMessage(result.detail || '保存失败', 'error');
                }
            } catch (e) {
                showMessage('保存失败: ' + e.message, 'error');
            }
        });

        // ==================== 账本 Tab: 账户管理 ====================

        let ledgerAccounts = {};

        async function loadLedgerAccounts() {
            try {
                const resp = await fetch('/api/ledger/accounts', { headers: getAuthHeaders() });
                if (resp.status === 401) { localStorage.removeItem('auth_token'); window.location.href = '/login'; return; }
                const data = await resp.json();
                ledgerAccounts = data.accounts || {};
                renderAccountGroups();
            } catch (e) {
                console.error('Load accounts error:', e);
            }
        }

        function renderAccountGroups() {
            const container = document.getElementById('accountGroupsList');
            container.innerHTML = '';

            const types = ['Assets', 'Liabilities', 'Income', 'Expenses', 'Equity'];
            types.forEach(type => {
                // 排序：开启的账户在前，关闭的账户在后
                const accounts = (ledgerAccounts[type] || []).slice().sort((a, b) => {
                    if (a.status === 'open' && b.status === 'closed') return -1;
                    if (a.status === 'closed' && b.status === 'open') return 1;
                    return 0;
                });
                const label = ACCOUNT_TYPE_LABELS[type];

                const group = document.createElement('div');
                group.className = 'border border-gray-200 rounded-lg overflow-hidden';
                group.innerHTML = `
                    <button class="group-toggle w-full flex justify-between items-center px-4 py-3 bg-gray-50 hover:bg-gray-100 transition text-left">
                        <span class="text-sm font-semibold text-gray-700">${type} (${label}) <span class="font-normal text-gray-400">${accounts.length} 个账户</span></span>
                        <svg class="group-arrow w-4 h-4 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <div class="group-content hidden">
                        ${accounts.length === 0
                            ? '<p class="px-4 py-3 text-sm text-gray-400">暂无账户</p>'
                            : accounts.map(acc => renderAccountRow(acc)).join('')
                        }
                    </div>
                `;
                container.appendChild(group);

                // 折叠/展开
                const toggle = group.querySelector('.group-toggle');
                const content = group.querySelector('.group-content');
                const arrow = group.querySelector('.group-arrow');
                toggle.addEventListener('click', () => {
                    content.classList.toggle('hidden');
                    arrow.classList.toggle('rotate-180');
                });

                // 默认展开有账户的分组
                if (accounts.length > 0) {
                    content.classList.remove('hidden');
                    arrow.classList.add('rotate-180');
                }

                // 绑定关闭按钮事件
                group.querySelectorAll('.close-acc-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openCloseModal(btn.dataset.account, btn.dataset.comment);
                    });
                });
            });
        }

        function renderAccountRow(acc) {
            const isClosed = acc.status === 'closed';
            const nameClass = isClosed ? 'text-gray-400 line-through' : 'text-gray-800';
            const currencyText = acc.currencies.length > 0 ? acc.currencies.join(', ') : '*';
            const commentText = acc.comment ? `<span class="text-gray-400 ml-2">${acc.comment}</span>` : '';
            const closeBtn = isClosed
                ? `<span class="text-xs text-gray-400">已关闭 (${acc.close_date})</span>`
                : `<button class="close-acc-btn text-xs text-red-500 hover:text-red-700 font-medium transition" data-account="${acc.name}" data-comment="${acc.comment || ''}">关闭</button>`;

            return `
                <div class="flex items-center justify-between px-4 py-2 border-t border-gray-100 hover:bg-gray-50">
                    <div class="flex-1 min-w-0">
                        <span class="text-sm ${nameClass} font-mono">${acc.name}</span>
                        <span class="text-xs text-gray-400 ml-2">${currencyText}</span>
                        ${commentText}
                    </div>
                    <div class="shrink-0 ml-3">${closeBtn}</div>
                </div>
            `;
        }

        // ==================== 新增账户 ====================

        // 实时预览
        function updateNewAccPreview() {
            const type = document.getElementById('newAccType').value;
            const path = document.getElementById('newAccPath').value.trim();
            const currency = document.getElementById('newAccCurrency').value.trim();
            const comment = document.getElementById('newAccComment').value.trim();
            const preview = document.getElementById('newAccPreview');

            if (!path) {
                preview.classList.add('hidden');
                return;
            }

            const currencyPart = currency ? ` ${currency}` : '';
            const commentPart = comment ? ` ; ${comment}` : '';
            preview.textContent = `1999-01-01 open ${type}:${path}${currencyPart}${commentPart}`;
            preview.classList.remove('hidden');
        }

        document.getElementById('newAccType').addEventListener('change', updateNewAccPreview);
        document.getElementById('newAccPath').addEventListener('input', updateNewAccPreview);
        document.getElementById('newAccCurrency').addEventListener('input', updateNewAccPreview);
        document.getElementById('newAccComment').addEventListener('input', updateNewAccPreview);

        // 前端校验
        function validateAccountPath(path) {
            if (!path) return '账户路径不能为空';
            if (path.startsWith(':') || path.endsWith(':')) return '路径格式不正确';
            if (path.includes('::')) return '路径格式不正确';

            const segments = path.split(':');
            // 第一段（完整账户名的第二级）必须以大写字母或数字开头
            if (!/^[A-Z0-9]/.test(segments[0])) return '第一段名称必须以大写字母或数字开头';
            // 后续每一段不能以小写字母开头
            for (let i = 1; i < segments.length; i++) {
                if (/^[a-z]/.test(segments[i])) return `第${i + 1}段 "${segments[i]}" 不能以小写字母开头`;
            }

            return null; // 通过
        }

        // 实时校验提示
        document.getElementById('newAccPath').addEventListener('input', () => {
            const path = document.getElementById('newAccPath').value.trim();
            const errorEl = document.getElementById('newAccError');
            if (!path) { errorEl.classList.add('hidden'); return; }
            const error = validateAccountPath(path);
            if (error) {
                errorEl.textContent = error;
                errorEl.classList.remove('hidden');
            } else {
                errorEl.classList.add('hidden');
            }
        });

        // 提交新增
        document.getElementById('addNewAccBtn').addEventListener('click', async () => {
            const type = document.getElementById('newAccType').value;
            const path = document.getElementById('newAccPath').value.trim();
            const currency = document.getElementById('newAccCurrency').value.trim();
            const comment = document.getElementById('newAccComment').value.trim();
            const errorEl = document.getElementById('newAccError');

            const error = validateAccountPath(path);
            if (error) {
                errorEl.textContent = error;
                errorEl.classList.remove('hidden');
                return;
            }

            try {
                const resp = await fetch('/api/ledger/accounts', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ account_type: type, path, currencies: currency, comment })
                });
                const result = await resp.json();
                if (resp.ok && result.success) {
                    showMessage(result.message);
                    // 清空表单
                    document.getElementById('newAccPath').value = '';
                    document.getElementById('newAccCurrency').value = '';
                    document.getElementById('newAccComment').value = '';
                    document.getElementById('newAccPreview').classList.add('hidden');
                    errorEl.classList.add('hidden');
                    // 刷新列表
                    await loadLedgerAccounts();
                } else {
                    showMessage(result.detail || '添加失败', 'error');
                }
            } catch (e) {
                showMessage('添加失败: ' + e.message, 'error');
            }
        });

        // ==================== 关闭账户 ====================

        let pendingCloseAccount = '';

        function openCloseModal(accountName, comment) {
            pendingCloseAccount = accountName;
            document.getElementById('closeAccountName').textContent = accountName + (comment ? ` (${comment})` : '');
            document.getElementById('closeAccountDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('closeAccountModal').classList.remove('hidden');
        }

        document.getElementById('closeAccountCancel').addEventListener('click', () => {
            document.getElementById('closeAccountModal').classList.add('hidden');
            pendingCloseAccount = '';
        });

        document.getElementById('closeAccountModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                document.getElementById('closeAccountModal').classList.add('hidden');
                pendingCloseAccount = '';
            }
        });

        document.getElementById('closeAccountConfirm').addEventListener('click', async () => {
            if (!pendingCloseAccount) return;
            const date = document.getElementById('closeAccountDate').value;

            try {
                const resp = await fetch('/api/ledger/accounts/close', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ account_name: pendingCloseAccount, date })
                });
                const result = await resp.json();
                if (resp.ok && result.success) {
                    showMessage(result.message);
                    document.getElementById('closeAccountModal').classList.add('hidden');
                    pendingCloseAccount = '';
                    await loadLedgerAccounts();
                } else {
                    showMessage(result.detail || '关闭失败', 'error');
                }
            } catch (e) {
                showMessage('关闭失败: ' + e.message, 'error');
            }
        });

        // ==================== 加载配置 (基础+高级) ====================

        async function loadConfig() {
            if (!checkAuth()) return;
            try {
                const resp = await fetch('/api/config/full', { headers: getAuthHeaders() });
                if (resp.status === 401) { localStorage.removeItem('auth_token'); window.location.href = '/login'; return; }
                configData = await resp.json();
                renderBasicTab();
                renderAdvancedTab();
            } catch (e) {
                console.error('Load config error:', e);
                showMessage('加载配置失败: ' + e.message, 'error');
            }
        }

        // ==================== Tab 1: 基础配置渲染 ====================

        function renderBasicTab() {
            const accounts = configData.system?.balance_accounts || [];
            const list = document.getElementById('accountsList');
            list.innerHTML = '';
            accounts.forEach(acc => addAccountRow(acc));

            const imap = configData.email?.imap || {};
            document.getElementById('email_host').value = imap.host || '';
            document.getElementById('email_port').value = imap.port || '';
            document.getElementById('email_username').value = imap.username || '';
            document.getElementById('email_password').value = '';
            document.getElementById('email_mailbox').value = imap.mailbox || '';
        }

        function addAccountRow(value = '') {
            const list = document.getElementById('accountsList');
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2';
            div.innerHTML = `
                <input type="text" class="account-input flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm" value="${value}" placeholder="例如 Assets:BoC:Card:XXX">
                <button type="button" class="remove-btn text-gray-400 hover:text-red-500 transition p-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            `;
            list.appendChild(div);
            div.querySelector('.remove-btn').addEventListener('click', () => div.remove());
        }

        document.getElementById('addAccountBtn').addEventListener('click', () => addAccountRow());

        // ==================== Tab 2: 高级配置渲染 ====================

        function renderAdvancedTab() {
            document.getElementById('unknown_expense_account').value = configData.unknown_expense_account || '';
            document.getElementById('unknown_income_account').value = configData.unknown_income_account || '';

            renderImporterFields('alipay_fields', configData.importers?.alipay || {});
            renderImporterFields('wechat_fields', configData.importers?.wechat || {});
            renderImporterFields('thu_ecard_fields', configData.importers?.thu_ecard || {});
            renderHsbcFields();

            const whitelist = configData.importers?.card_narration_whitelist || [];
            const blacklist = configData.importers?.card_narration_blacklist || [];
            // Prefill defaults if empty
            const DEFAULT_WHITELIST = ['财付通(银联云闪付)'];
            const DEFAULT_BLACKLIST = ['支付宝', '财付通', '美团支付'];
            renderStringList('whitelist_items', whitelist.length > 0 ? whitelist : DEFAULT_WHITELIST);
            renderStringList('blacklist_items', blacklist.length > 0 ? blacklist : DEFAULT_BLACKLIST);

            renderCardAccounts();
            renderDetailMappings();

            document.querySelectorAll('.add-list-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    addStringListRow(btn.dataset.target);
                });
            });

            document.getElementById('addCardAccountBtn').addEventListener('click', () => addCardAccountRow());
        }

        function renderImporterFields(containerId, data) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            for (const [key, value] of Object.entries(data)) {
                if (key === 'category_mapping' || key === 'account_mapping') continue;
                const div = document.createElement('div');
                const inputType = typeof value === 'boolean' ? 'checkbox' : 'text';
                if (inputType === 'checkbox') {
                    div.className = 'flex items-center gap-2';
                    div.innerHTML = `
                        <input type="checkbox" class="importer-field rounded border-gray-300 text-blue-600 focus:ring-blue-500" data-key="${key}" ${value ? 'checked' : ''}>
                        <label class="text-sm text-gray-600">${key}</label>
                    `;
                } else {
                    div.innerHTML = `
                        <label class="block text-sm font-medium text-gray-600 mb-1">${key}</label>
                        <input type="text" class="importer-field w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm" data-key="${key}" value="${value || ''}">
                    `;
                }
                container.appendChild(div);
            }
        }

        function renderHsbcFields() {
            const data = configData.importers?.hsbc_hk || {};
            document.getElementById('hsbc_use_cnh').checked = !!data.use_cnh;
            const mapping = data.account_mapping || {};
            document.getElementById('hsbc_account_one').value = mapping.One || '';
            document.getElementById('hsbc_account_pulse').value = mapping.PULSE || '';
        }

        function renderStringList(containerId, items) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            items.forEach(item => addStringListRow(containerId, item));
        }

        function addStringListRow(containerId, value = '') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2';
            div.innerHTML = `
                <input type="text" class="list-item flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm" value="${value}">
                <button type="button" class="remove-btn text-gray-400 hover:text-red-500 transition p-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            `;
            container.appendChild(div);
            div.querySelector('.remove-btn').addEventListener('click', () => div.remove());
        }

        function renderCardAccounts() {
            const container = document.getElementById('cardAccountRows');
            container.innerHTML = '';
            const data = configData.card_accounts || {};
            // Flatten nested structure: {category: {middleName: [suffix, ...]}} → rows
            for (const [category, middleMap] of Object.entries(data)) {
                for (const [middleName, suffixes] of Object.entries(middleMap)) {
                    for (const suffix of suffixes) {
                        addCardAccountRow(category, middleName, String(suffix));
                    }
                }
            }
        }

        function addCardAccountRow(category = 'Assets', middleName = '', suffix = '') {
            const container = document.getElementById('cardAccountRows');
            const div = document.createElement('div');
            div.className = 'card-account-row border border-gray-200 rounded-lg p-3 space-y-2';

            div.innerHTML = `
                <div class="flex items-center gap-2">
                    <select class="ca-category px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm bg-white shrink-0">
                        <option value="Assets" ${category === 'Assets' ? 'selected' : ''}>Assets (资产)</option>
                        <option value="Liabilities" ${category === 'Liabilities' ? 'selected' : ''}>Liabilities (负债)</option>
                    </select>
                    <span class="text-gray-400 shrink-0">:</span>
                    <input type="text" class="ca-middle flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm" value="${middleName}" placeholder="中间名称，如 BOC:Card">
                    <span class="text-gray-400 shrink-0">:</span>
                    <input type="text" class="ca-suffix w-24 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-sm font-mono" value="${suffix}" placeholder="后四位" maxlength="4">
                    <button type="button" class="remove-btn text-gray-400 hover:text-red-500 transition p-1 shrink-0">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                <div class="flex items-center gap-2">
                    <div class="ca-preview text-xs font-mono text-gray-500 flex-1"></div>
                    <div class="ca-error text-xs text-red-500 hidden"></div>
                </div>
            `;
            container.appendChild(div);
            div.querySelector('.remove-btn').addEventListener('click', () => div.remove());

            // Auto-append colon to middle name
            const middleInput = div.querySelector('.ca-middle');
            const suffixInput = div.querySelector('.ca-suffix');
            const updatePreview = () => updateCardAccountPreview(div);

            middleInput.addEventListener('blur', () => {
                let val = middleInput.value.trim();
                // Remove trailing colon if present (it's added in the preview automatically)
                if (val.endsWith(':')) {
                    middleInput.value = val.slice(0, -1);
                } else {
                    middleInput.value = val;
                }
                updatePreview();
            });
            middleInput.addEventListener('input', updatePreview);
            suffixInput.addEventListener('input', () => {
                // Allow only digits and uppercase letters
                suffixInput.value = suffixInput.value.replace(/[^0-9A-Z]/gi, '').toUpperCase();
                updatePreview();
            });
            div.querySelector('.ca-category').addEventListener('change', updatePreview);
            updatePreview();
        }

        function updateCardAccountPreview(row) {
            const category = row.querySelector('.ca-category').value;
            const middle = row.querySelector('.ca-middle').value.trim();
            const suffix = row.querySelector('.ca-suffix').value.trim();
            const previewEl = row.querySelector('.ca-preview');
            const errorEl = row.querySelector('.ca-error');

            errorEl.classList.add('hidden');
            errorEl.textContent = '';

            if (!middle && !suffix) {
                previewEl.textContent = '';
                return;
            }

            // Validate middle name segments: first char must be uppercase or digit
            if (middle) {
                const cleanMiddle = middle.endsWith(':') ? middle.slice(0, -1) : middle;
                const segments = cleanMiddle.split(':');
                for (let i = 0; i < segments.length; i++) {
                    if (segments[i] && /^[a-z]/.test(segments[i])) {
                        errorEl.textContent = `"${segments[i]}" 不能以小写字母开头`;
                        errorEl.classList.remove('hidden');
                        break;
                    }
                }
            }

            // Validate suffix: must be exactly 4 chars of digits/uppercase
            if (suffix && suffix.length !== 4) {
                errorEl.textContent = '后四位必须是 4 个字符';
                errorEl.classList.remove('hidden');
            } else if (suffix && !/^[0-9A-Z]{4}$/.test(suffix)) {
                errorEl.textContent = '后四位只能包含数字和大写字母';
                errorEl.classList.remove('hidden');
            }

            const middlePart = middle.endsWith(':') ? middle.slice(0, -1) : middle;
            const parts = [category, middlePart, suffix].filter(Boolean);
            previewEl.textContent = parts.join(':');
        }

        // ==================== 交易匹配规则 ====================

        function renderDetailMappings() {
            const list = document.getElementById('detailMappingsList');
            list.innerHTML = '';
            const mappings = configData.detail_mappings || [];
            mappings.forEach(m => addMappingRow(m));
        }

        function addMappingRow(data = {}) {
            const list = document.getElementById('detailMappingsList');
            const div = document.createElement('div');
            div.className = 'mapping-item border border-gray-200 rounded-lg p-4 space-y-3';
            div.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="text-sm font-medium text-gray-700">匹配规则</span>
                    <button type="button" class="remove-btn text-gray-400 hover:text-red-500 transition text-sm">删除</button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">payee_keywords (逗号分隔)</label>
                        <input type="text" class="mapping-payee w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" value="${(data.payee_keywords || []).join(', ')}">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">narration_keywords (逗号分隔)</label>
                        <input type="text" class="mapping-narration w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" value="${(data.narration_keywords || []).join(', ')}">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">account</label>
                        <input type="text" class="mapping-account w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" value="${data.account || ''}">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">tags (逗号分隔)</label>
                        <input type="text" class="mapping-tags w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none" value="${(data.tags || []).join(', ')}">
                    </div>
                </div>
            `;
            list.appendChild(div);
            div.querySelector('.remove-btn').addEventListener('click', () => div.remove());
        }

        document.getElementById('addMappingBtn').addEventListener('click', () => addMappingRow());

        // ==================== 收集数据 ====================

        function collectBasicConfig() {
            const accounts = [];
            document.querySelectorAll('#accountsList .account-input').forEach(input => {
                const val = input.value.trim();
                if (val) accounts.push(val);
            });

            return {
                system: { balance_accounts: accounts },
                email: {
                    imap: {
                        host: document.getElementById('email_host').value.trim(),
                        port: parseInt(document.getElementById('email_port').value) || 993,
                        username: document.getElementById('email_username').value.trim(),
                        password: document.getElementById('email_password').value,
                        mailbox: document.getElementById('email_mailbox').value.trim()
                    }
                }
            };
        }

        function collectImporterData(containerId) {
            const result = {};
            document.querySelectorAll(`#${containerId} .importer-field`).forEach(el => {
                const key = el.dataset.key;
                if (el.type === 'checkbox') {
                    result[key] = el.checked;
                } else {
                    result[key] = el.value;
                }
            });
            return result;
        }

        function collectStringList(containerId) {
            const result = [];
            document.querySelectorAll(`#${containerId} .list-item`).forEach(input => {
                const val = input.value.trim();
                if (val) result.push(val);
            });
            return result;
        }

        function collectDetailMappings() {
            const mappings = [];
            document.querySelectorAll('#detailMappingsList .mapping-item').forEach(item => {
                const payee = item.querySelector('.mapping-payee').value.split(',').map(s => s.trim()).filter(Boolean);
                const narration = item.querySelector('.mapping-narration').value.split(',').map(s => s.trim()).filter(Boolean);
                const account = item.querySelector('.mapping-account').value.trim();
                const tags = item.querySelector('.mapping-tags').value.split(',').map(s => s.trim()).filter(Boolean);
                if (account || payee.length || narration.length) {
                    mappings.push({ payee_keywords: payee, narration_keywords: narration, account, tags });
                }
            });
            return mappings;
        }

        function collectAdvancedConfig() {
            const alipay = collectImporterData('alipay_fields');
            const wechat = collectImporterData('wechat_fields');
            const thu_ecard = collectImporterData('thu_ecard_fields');

            const hsbc_account_one = document.getElementById('hsbc_account_one').value.trim();
            const hsbc_account_pulse = document.getElementById('hsbc_account_pulse').value.trim();
            const hsbc_account_mapping = {};
            if (hsbc_account_one) hsbc_account_mapping.One = hsbc_account_one;
            if (hsbc_account_pulse) hsbc_account_mapping.PULSE = hsbc_account_pulse;
            const hsbc_hk = {
                use_cnh: document.getElementById('hsbc_use_cnh')?.checked || false,
                account_mapping: hsbc_account_mapping
            };

            // Collect card_accounts from structured rows
            const card_accounts = {};
            document.querySelectorAll('#cardAccountRows .card-account-row').forEach(row => {
                const category = row.querySelector('.ca-category').value;
                let middle = row.querySelector('.ca-middle').value.trim();
                const suffix = row.querySelector('.ca-suffix').value.trim();
                if (!middle || !suffix) return;
                // Remove trailing colon from display — stored key should NOT end with colon
                if (middle.endsWith(':')) middle = middle.slice(0, -1);
                if (!card_accounts[category]) card_accounts[category] = {};
                if (!card_accounts[category][middle]) card_accounts[category][middle] = [];
                if (!card_accounts[category][middle].includes(suffix)) {
                    card_accounts[category][middle].push(suffix);
                }
            });

            return {
                unknown_expense_account: document.getElementById('unknown_expense_account').value.trim(),
                unknown_income_account: document.getElementById('unknown_income_account').value.trim(),
                importers: {
                    alipay,
                    wechat,
                    thu_ecard,
                    hsbc_hk,
                    card_narration_whitelist: collectStringList('whitelist_items'),
                    card_narration_blacklist: collectStringList('blacklist_items')
                },
                card_accounts,
                detail_mappings: collectDetailMappings()
            };
        }

        // ==================== 保存配置 ====================

        async function saveConfig(data) {
            try {
                const resp = await fetch('/api/config/full', {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(data)
                });
                if (resp.status === 401) { localStorage.removeItem('auth_token'); window.location.href = '/login'; return; }
                const result = await resp.json();
                if (result.success) {
                    showMessage(result.message);
                    await loadConfig();
                } else {
                    showMessage(result.detail || '保存失败', 'error');
                }
            } catch (e) {
                showMessage('保存失败: ' + e.message, 'error');
            }
        }

        document.getElementById('saveBasicBtn').addEventListener('click', () => {
            saveConfig(collectBasicConfig());
        });

        document.getElementById('saveAdvancedBtn').addEventListener('click', () => {
            try {
                saveConfig(collectAdvancedConfig());
            } catch (e) {
                showMessage(e.message, 'error');
            }
        });

        // ==================== 修改密码 ====================

        document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const current = document.getElementById('currentPassword').value;
            const newPwd = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;

            if (newPwd !== confirm) {
                showMessage('两次输入的新密码不一致', 'error');
                return;
            }

            if (!newPwd.trim()) {
                showMessage('新密码不能为空', 'error');
                return;
            }

            try {
                const resp = await fetch('/api/config/change-password', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ current_password: current, new_password: newPwd })
                });
                const result = await resp.json();
                if (resp.ok && result.success) {
                    showMessage(result.message);
                    document.getElementById('changePasswordForm').reset();
                } else {
                    showMessage(result.detail || '修改失败', 'error');
                }
            } catch (e) {
                showMessage('修改失败: ' + e.message, 'error');
            }
        });

        // ==================== 退出登录 ====================

        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('token_expire_at');
            window.location.href = '/login';
        });

        // ==================== 初始化 ====================

        window.addEventListener('DOMContentLoaded', async () => {
            if (!checkAuth()) return;
            // 并行加载所有数据
            await Promise.all([
                loadLedgerInfo(),
                loadLedgerAccounts(),
                loadConfig()
            ]);
        });
    </script>
</body>
</html>
